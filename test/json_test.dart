import 'package:hn_app/src/article.dart';
import 'package:http/http.dart' as http;
import 'package:test/test.dart';

void main() {
  test("parses topstories.json", () {
    const String jsonString = "[17556497,17557593,17556955,17553371,17548138,"
        "17557688,17556351,17549469,17549866,17555842,17556805,17556001,17548300,17545922,17549219,17555695,17557614,17548610,17548641,17546280,17548713,17550448,17548023,17551819,17550858,17549189,17541989,17554902,17549897,17554591,17557413,17547856,17550837,17549050,17552517,17546063,17550600,17547368,17547726,17551012,17546340,17548146,17555775,17552132,17553012,17550761,17548359,17553001,17546491,17555870,17553505,17546205,17546915,17551370,17551514,17549837,17550283,17548768,17550315,17549099,17552532,17541045,17551796,17546996,17551399,17546207,17551229,17551286,17552282,17541600,17540464,17544250,17552100,17556922,17551687,17555429,17554377,17550199,17534858,17555337,17540205,17551717,17540401,17552024,17548676,17549995,17550754,17543323,17556556,17542051,17551650,17551457,17546875,17538390,17544689,17544687,17551353,17536441,17539548,17549797,17539726,17551171,17535995,17548198,17550532,17539765,17550170,17540321,17548623,17538322,17522362,17547817,17543357,17548807,17551797,17539361,17539465,17544666,17548270,17553364,17532682,17540200,17544281,17534817,17548675,17549325,17544300,17547480,17537512,17546979,17554955,17544161,17539969,17536291,17545529,17540383,17545518,17542949,17555115,17530086,17553591,17548731,17540712,17546876,17534923,17538453,17546835,17538697,17546731,17535909,17540263,17542803,17551542,17549293,17536741,17550379,17538770,17552412,17535218,17555511,17538261,17539595,17534596,17541065,17536184,17551893,17538135,17535958,17537907,17537250,17546006,17551623,17532094,17536658,17547562,17536958,17535367,17538352,17539409,17541092,17537031,17537647,17535534,17550823,17540094,17542864,17542556,17548536,17554326,17538949,17543925,17540313,17535752,17548268,17539825,17539286,17532358,17543650,17546832,17539552,17548103,17529780,17541317,17530014,17544288,17536442,17546054,17538517,17537182,17528817,17536302,17548764,17547703,17553430,17530512,17540791,17532003,17526420,17529326,17532354,17543449,17548285,17551374,17536717,17534632,17542993,17525741,17527702,17526492,17551105,17527880,17550987,17536352,17539696,17542964,17528927,17546734,17534633,17547092,17523623,17524086,17553753,17523371,17528735,17545251,17529703,17540001,17530498,17525029,17531490,17535789,17534950,17534652,17537642,17525858,17539133,17534245,17542522,17523809,17535392,17532360,17532693,17531713,17529923,17531575,17545488,17534044,17552909,17540384,17531739,17536737,17529154,17536474,17539900,17523978,17529179,17525521,17536382,17540119,17530018,17524596,17550101,17550420,17529408,17531875,17533341,17527846,17530223,17546409,17535317,17535861,17542972,17524064,17531314,17526016,17524169,17528195,17526574,17522020,17537489,17532839,17540598,17540393,17523926,17528031,17536445,17551119,17532823,17528187,17524130,17538093,17522988,17550698,17535496,17533365,17538090,17524879,17522319,17546773,17534376,17529815,17534336,17534209,17534480,17525142,17544798,17526866,17523480,17528882,17535138,17546302,17523475,17529710,17531666,17534860,17547352,17539484,17531608,17547267,17539244,17529135,17529520,17530609,17522258,17524239,17533661,17546854,17523498,17541080,17536298,17547170,17551211,17533636,17523056,17531537,17531227,17529599,17549934,17529319,17524794,17535751,17528431,17545142,17535209,17524957,17533477,17530996,17521994,17537675,17524693,17523149,17535937,17533782,17545827,17534719,17529248,17528141,17542580,17522731,17536074,17522528,17537176,17528652,17531789,17545398,17535104,17523967,17533560,17541471,17531933,17543114,17543510,17526973,17543103,17533578,17525166,17545795,17522224,17524928,17540190,17544225,17538158,17524626,17546929,17530703,17525260,17546673,17546619,17530813,17541224,17528588,17528520,17536296,17534969,17522307,17541658,17544764,17528267,17539598,17545113,17544518,17527985,17527692,17532814,17544705,17527618,17526872,17523374,17543792,17536053,17525352,17529790,17539049,17539222,17525534,17544213,17536846,17528178,17534023,17522535,17528536,17530099,17525572,17543210,17535053,17538054,17528606,17536491,17527499,17528419,17532546,17526672,17522578,17547414,17536301,17534985,17530359,17538349,17531956,17530271,17534136,17538123,17544479,17525934,17522649,17533346,17540904,17531522,17533910,17527696,17542919,17536126,17525507,17546332,17535801,17536272,17526599,17534662,17525917,17529109,17534483,17531040,17524193,17534324,17523769,17528324,17522961,17530239,17548733,17528491,17533618,17529246,17522363,17527151,17535165,17531504,17532033,17523924,17531818,17525982]";

    expect(parseTopStories(jsonString).first, 17556497);
  });

  test("parses articles.json", () {
    const String jsonString =
        """{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8952,8917,8884,8887,8943,8869,8940,8908,8958,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}""";

    expect(parseArticle(jsonString).by, "dhouston");
  });

  test("parses articles.json over a network", () async {
    final url = 'https://hacker-news.firebaseio.com/v0/beststories.json';

    final response = await http.get(url);

    if (response.statusCode == 200) {
      final idList = parseTopStories(response.body);

      if (idList.isNotEmpty) {
        final storyUrl = 'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';

        final storyResponse = await http.get(storyUrl);

        if (storyResponse.statusCode == 200) {
          expect(parseArticle(storyResponse.body), isNotNull);
        }
      }
    }
  });
}
